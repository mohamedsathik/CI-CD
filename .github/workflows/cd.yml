name: Docker Image CD

on:
    workflow_run:
      workflows: ["Docker Image CI"]
      types:
        - completed


jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Login into AWS instances
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2HOSTNAME }}
          username: ${{ secrets.EC2USERNAME }}
          key: ${{ secrets.EC2KEY }}

      - name: Install Docker
        run: |
          if ! command -v docker &> /dev/null
          then
              echo "Docker is not installed. Installing Docker..."
              curl -fsSL https://get.docker.com | sh
          else
              echo "Docker is already installed."
          fi
          
      - name: Check for usermod is present here
        run: |
          if groups | grep -q docker; then
            echo "USer is already exist"
          else
            echo "User is not a part of group"
            sudo usermod -a -G docker $(whoami)
            newgrp docker
          fi

      - name: Login Docker account
        run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

      - name: built the  docekr Images
        run: docker pull alexkhan2628/ci-cd:latest

      - name: Run docker Container
        run: docker run -d --name ci-cd-container -p 3000:3000 alexkhan2628/ci-cd:latest
